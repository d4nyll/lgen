<template name="ChatRoom">
  {{#if Template.subscriptionsReady}}
    {{#contentFor "headerTitle"}}
      <h1 class="title">
          {{#if isChatRoomAvatar}}
            {{{getGroupAvatar}}}
          {{else}}
            {{{getUserAvatar}}}
          {{/if}}
          {{getChatRoomName}}
      </h1>
    {{/contentFor}}
    {{#contentFor "headerButtonLeft"}}
      {{>ionNavBackButton href="/chat" text=" "}}
    {{/contentFor}}
    {{#contentFor "headerButtonRight"}}
      <div style="position: absolute; right: 0;">
        <a href="{{pathFor 'ChatRoomInformation'   chatRoomId= getChatRoomId  }}"
           class="button button-clear button-entering button-active "><i class="icon ion-ios-information-outline"></i></a>
        <!-- <button  class="button button-clear button-entering button-active addClassBtn">?</button> -->
      </div>
    {{/contentFor}}
    {{#ionView}}
      {{#ionContent}}
        <div class="list chatroomList background-wallpaper" id="messageList">
          <div class='date-bubble-wrapper {{isLoadMoreButtonShow}}'><button class='load-prev-msg'>{{_ "smartix-chat.Loadmessage" }}</button> </div>
          {{#each chatRoomProfile}}
            {{#if isFirstMsgInOneDay}}
              <div class='date-bubble-wrapper'> <div class='date-bubble'>{{formatDate2 createdAt}}</div> </div>
            {{/if}}
            <div class="item {{isMine}}">
              <div class="bubble">
                {{#if isMineBoolean author}}
                    {{else}}
                      {{#with getUserById author}}
                        <div class='username'>
                          {{#if isGroupChat}}
                            {{#if profile.avatarValue}}
                              {{#if isEmoji this}}
                                <i class="icon e1a-{{profile.avatarValue}} e1a-1x emojicon"></i>
                              {{else}}
                                <img class="icon icon-avatar e1a-1x" src="{{profile.avatarValue}}" />
                              {{/if}}
                            {{else}}
                              <i class="icon e1a-green_apple e1a-1x emojicon"></i>
                            {{/if}}
                            {{profile.firstName}} {{profile.lastName}}
                          {{/if}}
                          <i style='larger' class="icon {{isNewMessage ../createdAt}}  new-message-icon"></i>
                        </div>
                        <br/>
                      {{/with}}
                  {{/if}}
                {{#if isText}}
                    {{#autolink}}<pre>{{data.content}}</pre>{{/autolink}}
                {{else}}
                {{#each addons}}
                  {{#with FS.GetFile "images" fileId}}
                    <!--read the below to know how to access parent scope value-->
                    <!--https://www.discovermeteor.com/blog/a-guide-to-meteor-templates-data-contexts/-->
                    <!--<style>.bubble.image-bubble.image{{@index}}:after{content:"{{formatTime  ../../createdAt}}";white-space: nowrap;}</style>-->
                    <!--<div class="image-bubble image{{@index}}">-->
                      <!--http://stackoverflow.com/questions/10426786/div-gets-extra-height-for-no-reason-->
                      <img style='display:block;' src="{{this.url store='thumbs'  }}" alt="" class="imgThumbs responsive-img" data-fullsizeimage="{{this.url  }}">
                    <!--</div>-->
                  {{/with}}
                    {{#with FS.GetFile "stickers" fileId}}
                    <!--read the below to know how to access parent scope value-->
                    <!--https://www.discovermeteor.com/blog/a-guide-to-meteor-templates-data-contexts/-->
                    <!--<style>.bubble.image-bubble.image{{@index}}:after{content:"{{formatTime  ../../createdAt}}";white-space: nowrap;}</style>-->
                    <!--<div class="image-bubble image{{@index}}">-->
                      <!--http://stackoverflow.com/questions/10426786/div-gets-extra-height-for-no-reason-->
                      <img style='display:block; max-width:225px' src="{{this.url store='stickers'  }}" alt="" class="responsive-img">
                    <!--</div>-->
                    <p>New Sticker!</p>
                  {{/with}}
                  {{#with FS.GetFile "documents" fileId}}
                    {{#if this.isUploaded}}
                      {{#if this.hasStored 'documents'}}
                        <!--<div class="bubble">-->
                          <a href='{{this.url}}'> <i class="icon ion-paperclip"></i>&nbsp;{{this.name}}</a>
                      {{else}}
                        {{> LoadingSpinner}}
                      {{/if}}
                    {{else}}
                      {{> LoadingSpinner}}
                    {{/if}}
                      <br />
                  {{/with}}
                  {{#with FS.GetFile "sounds" fileId}}
                    {{#if this.isUploaded}}
                      {{#if this.hasStored 'sounds'}}
                        {{#if  this.url}}
                          {{#if isCordova}}
                              <a class="button button-icon icon ion-play playBtn" data-clipid="{{_id}}"></a>
                          {{else}}
                              <audio controls>
                                <source src="{{this.url}}" type="audio/wav">
                              </audio>
                          {{/if}}
                        {{/if}}
                      {{/if}}
                    {{/if}}
                  {{/with}}
                {{/each}}    
                  {{#if addonHasContent }}
                    {{#autolink}}<pre>{{data.content}}</pre>{{/autolink}}
                  {{/if}}
                {{/if}}
                  <span class='timestamp'>{{formatTime createdAt}}</span>
              </div>
            </div>
          {{/each}}
        </div>
        {{> SendMessage callFromClassPanel=true }}
      {{/ionContent}}
    {{/ionView}}
  {{/if}} 
</template>

<template name="imageModal">
  {{#ionModal title="" }}
    <div class="row row-center" style="height:100%">
      <div class="col" style="text-align: center;">
        <img src="{{src}}" alt="" style="max-width:100%">
      </div>
    </div>
  {{/ionModal}}
</template>
